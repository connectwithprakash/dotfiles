#!/usr/bin/env bash
# Dotfiles CLI - Main entry point for managing dotfiles
#
# Usage:
#   dotfiles                # Launch interactive menu
#   dotfiles sync           # Sync dotfiles
#   dotfiles install        # Install components
#   dotfiles status         # Show status
#   dotfiles health         # Run health check
#   dotfiles help           # Show help

set -e

# Get the directory where this script is located
DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
GRAY='\033[0;90m'
NC='\033[0m' # No Color

# Check if gum is available
HAS_GUM=false
if command -v gum &> /dev/null; then
  HAS_GUM=true
fi

# Helper functions
print_header() {
  if [ "$HAS_GUM" = true ]; then
    gum style \
      --border double \
      --border-foreground 212 \
      --padding "0 2" \
      --margin "1 0" \
      "$1"
  else
    echo ""
    echo -e "${BLUE}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    echo -e "${BLUE}â”‚${NC}  $1"
    echo -e "${BLUE}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    echo ""
  fi
}

print_success() {
  echo -e "${GREEN}âœ“${NC} $1"
}

print_error() {
  echo -e "${RED}âœ—${NC} $1"
}

print_info() {
  echo -e "${CYAN}â„¹${NC} $1"
}

# Show help
show_help() {
  print_header "Dotfiles Manager - Help"

  echo -e "${CYAN}Usage:${NC}"
  echo "  dotfiles [command] [options]"
  echo ""
  echo -e "${CYAN}Commands:${NC}"
  echo -e "  ${GREEN}sync${NC}       Sync dotfiles between home directory and repository"
  echo -e "  ${GREEN}install${NC}    Install or update components"
  echo -e "  ${GREEN}status${NC}     Show current status of dotfiles and components"
  echo -e "  ${GREEN}health${NC}     Run health check on installed components"
  echo -e "  ${GREEN}help${NC}       Show this help message"
  echo ""
  echo -e "${CYAN}Examples:${NC}"
  echo "  dotfiles                # Launch interactive menu (default)"
  echo "  dotfiles sync           # Sync dotfiles interactively"
  echo "  dotfiles install        # Install components interactively"
  echo "  dotfiles status         # Show current status"
  echo "  dotfiles health         # Run health check"
  echo ""
  echo -e "${GRAY}For more information, see: $DOTFILES_DIR/CLAUDE.md${NC}"
}

# Show status
show_status() {
  print_header "Dotfiles Status"

  # Check installed components
  echo -e "${CYAN}Installed Components:${NC}"

  # Zsh
  if command -v zsh &> /dev/null; then
    ZSH_VERSION=$(zsh --version | awk '{print $2}')
    print_success "Zsh $ZSH_VERSION"
    if [ -d "$HOME/.oh-my-zsh" ]; then
      echo -e "  ${GRAY}â†’ Oh My Zsh installed${NC}"
    fi
  else
    echo -e "${GRAY}  - Zsh (not installed)${NC}"
  fi

  # Neovim
  if command -v nvim &> /dev/null; then
    NVIM_VERSION=$(nvim --version | head -n1 | awk '{print $2}')
    print_success "Neovim $NVIM_VERSION"
  else
    echo -e "${GRAY}  - Neovim (not installed)${NC}"
  fi

  # VS Code
  if command -v code &> /dev/null; then
    CODE_VERSION=$(code --version | head -n1)
    print_success "VS Code $CODE_VERSION"
  else
    echo -e "  ${GRAY}- VS Code (not installed)${NC}"
  fi

  # Claude Code
  if [ -f "$HOME/.claude/settings.json" ]; then
    print_success "Claude Code (configured)"
    SKILL_COUNT=$(find "$HOME/.claude/skills" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    echo -e "  ${GRAY}â†’ $SKILL_COUNT skill(s) installed${NC}"
  else
    echo -e "${GRAY}  - Claude Code (not configured)${NC}"
  fi

  # Gum & fzf
  echo ""
  echo -e "${CYAN}TUI Tools:${NC}"
  if command -v gum &> /dev/null; then
    print_success "gum (installed)"
  else
    echo -e "${GRAY}  - gum (not installed)${NC}"
  fi

  if command -v fzf &> /dev/null; then
    print_success "fzf (installed)"
  else
    echo -e "${GRAY}  - fzf (not installed)${NC}"
  fi

  # Check for unsynced changes
  echo ""
  echo -e "${CYAN}Sync Status:${NC}"
  cd "$DOTFILES_DIR"
  if git status --porcelain | grep -q .; then
    print_info "Uncommitted changes in repository"
  else
    print_success "Repository is clean"
  fi

  # Check dotfiles
  CHANGED=0
  if [ -f "$HOME/.zshrc" ] && [ -f "$DOTFILES_DIR/zsh/.zshrc" ]; then
    if ! diff -q "$HOME/.zshrc" "$DOTFILES_DIR/zsh/.zshrc" &>/dev/null; then
      ((CHANGED++))
    fi
  fi

  if [ "$CHANGED" -gt 0 ]; then
    print_info "$CHANGED dotfile(s) have unsync'd changes"
  else
    print_success "All dotfiles are synced"
  fi
}

# Main menu
show_menu() {
  if [ "$HAS_GUM" = true ]; then
    # Beautiful Gum menu
    gum style \
      --border double \
      --border-foreground 212 \
      --padding "1 2" \
      --margin "1 0" \
      "ðŸ  Dotfiles Manager" \
      "" \
      "Manage your development environment"

    CHOICE=$(gum choose \
      "ðŸ”„ Sync Dotfiles" \
      "ðŸ“¦ Install Components" \
      "ðŸ“Š Show Status" \
      "ðŸ¥ Run Health Check" \
      "â“ Help" \
      "âŒ Exit")

    case "$CHOICE" in
      "ðŸ”„ Sync Dotfiles")
        "$DOTFILES_DIR/update_dotfiles.sh"
        ;;
      "ðŸ“¦ Install Components")
        "$DOTFILES_DIR/bootstrap.sh"
        ;;
      "ðŸ“Š Show Status")
        show_status
        ;;
      "ðŸ¥ Run Health Check")
        run_health_check
        ;;
      "â“ Help")
        show_help
        ;;
      "âŒ Exit")
        echo "Goodbye! ðŸ‘‹"
        exit 0
        ;;
    esac
  else
    # Basic text menu
    print_header "Dotfiles Manager"
    echo "1) Sync Dotfiles"
    echo "2) Install Components"
    echo "3) Show Status"
    echo "4) Run Health Check"
    echo "5) Help"
    echo "6) Exit"
    echo ""
    read -p "Choose an option (1-6): " choice

    case $choice in
      1) "$DOTFILES_DIR/update_dotfiles.sh" ;;
      2) "$DOTFILES_DIR/bootstrap.sh" ;;
      3) show_status ;;
      4) run_health_check ;;
      5) show_help ;;
      6) echo "Goodbye! ðŸ‘‹"; exit 0 ;;
      *) echo "Invalid option"; exit 1 ;;
    esac
  fi
}

# Health check
run_health_check() {
  print_header "System Health Check"

  ERRORS=0
  WARNINGS=0

  # Check shell
  echo -e "${CYAN}Shell Configuration:${NC}"
  if [ "$SHELL" = "/bin/zsh" ] || [ "$SHELL" = "/usr/bin/zsh" ]; then
    print_success "Zsh is default shell"
  else
    print_info "Default shell: $SHELL (consider switching to Zsh)"
    ((WARNINGS++))
  fi

  if [ -f "$HOME/.zshrc" ]; then
    print_success ".zshrc exists"
  else
    print_error ".zshrc not found"
    ((ERRORS++))
  fi

  # Check development tools
  echo ""
  echo -e "${CYAN}Development Tools:${NC}"
  for tool in git nvim code gum fzf jq tree; do
    if command -v "$tool" &> /dev/null; then
      print_success "$tool installed"
    else
      print_info "$tool not installed (optional)"
      ((WARNINGS++))
    fi
  done

  # Check ripgrep (binary is 'rg')
  if command -v rg &> /dev/null; then
    print_success "ripgrep installed"
  else
    print_info "ripgrep not installed (optional)"
    ((WARNINGS++))
  fi

  # Check Neovim plugins
  if command -v nvim &> /dev/null; then
    echo ""
    echo -e "${CYAN}Neovim Configuration:${NC}"
    if [ -f "$HOME/.config/nvim/init.vim" ]; then
      print_success "init.vim exists"
    else
      print_info "init.vim not found"
      ((WARNINGS++))
    fi

    if [ -f "$HOME/.local/share/nvim/site/autoload/plug.vim" ]; then
      print_success "Vim-Plug installed"
    else
      print_info "Vim-Plug not installed"
      ((WARNINGS++))
    fi
  fi

  # Summary
  echo ""
  echo -e "${CYAN}Summary:${NC}"
  if [ "$ERRORS" -eq 0 ] && [ "$WARNINGS" -eq 0 ]; then
    print_success "All checks passed! System is healthy ðŸŽ‰"
  elif [ "$ERRORS" -eq 0 ]; then
    print_info "$WARNINGS warning(s) found"
  else
    print_error "$ERRORS error(s) and $WARNINGS warning(s) found"
  fi
}

# Main command router
cd "$DOTFILES_DIR"

case "${1:-menu}" in
  sync)
    shift
    "$DOTFILES_DIR/update_dotfiles.sh" "$@"
    ;;
  install)
    shift
    "$DOTFILES_DIR/bootstrap.sh" "$@"
    ;;
  status)
    show_status
    ;;
  health)
    run_health_check
    ;;
  help|--help|-h)
    show_help
    ;;
  menu|"")
    show_menu
    ;;
  *)
    echo -e "${RED}Unknown command: $1${NC}"
    echo "Run 'dotfiles help' for usage information"
    exit 1
    ;;
esac
